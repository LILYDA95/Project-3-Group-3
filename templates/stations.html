{% extends "base.html" %}

{% block content %}
<div id="map" style="height: 400px;"></div>

<script>
    var map = L.map('map').setView([36.7783, -119.4179], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Function to fetch and display charging stations based on map's center
    function fetchStations() {
        const center = map.getCenter();

        fetch(`/api/charging-stations/?lat=${center.lat}&lng=${center.lng}`)
        .then(response => response.json())
        .then(data => {
            // Clear existing markers
            map.eachLayer(layer => {
                if(layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            data.forEach(station => {
                if (station.AddressInfo && station.AddressInfo.Latitude && station.AddressInfo.Longitude) {
                    L.marker([station.AddressInfo.Latitude, station.AddressInfo.Longitude]).addTo(map)
                    .bindPopup(station.AddressInfo.Title || "Unknown Station");
                }
            });
        })
        .catch(error => {
            console.error('Error fetching the charging stations:', error);
        });
    }

    // Call the function initially to load stations at the start
    fetchStations();

    // Attach the function to the moveend event to fetch stations dynamically based on map movement
    map.on('moveend', fetchStations);
</script>
{% endblock %}
